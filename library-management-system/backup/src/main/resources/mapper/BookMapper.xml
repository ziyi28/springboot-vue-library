<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.library.mapper.BookMapper">

    <resultMap id="BookWithCategoryMap" type="com.library.entity.Book">
        <id column="id" property="id"/>
        <result column="isbn" property="isbn"/>
        <result column="title" property="title"/>
        <result column="author" property="author"/>
        <result column="publisher" property="publisher"/>
        <result column="publish_date" property="publishDate"/>
        <result column="category_id" property="categoryId"/>
        <result column="description" property="description"/>
        <result column="cover_image" property="coverImage"/>
        <result column="page_count" property="pageCount"/>
        <result column="language" property="language"/>
        <result column="price" property="price"/>
        <result column="total_copies" property="totalCopies"/>
        <result column="available_copies" property="availableCopies"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="is_deleted" property="isDeleted"/>
        <association property="category" javaType="com.library.entity.BookCategory">
            <id column="category_id" property="id"/>
            <result column="category_name" property="categoryName"/>
            <result column="category_code" property="categoryCode"/>
        </association>
    </resultMap>

    <select id="selectBooksWithCategory" resultMap="BookWithCategoryMap">
        SELECT b.*, c.category_name, c.category_code
        FROM books b
        LEFT JOIN book_categories c ON b.category_id = c.id
        WHERE b.is_deleted = 0
        <if test="title != null and title != ''">
            AND b.title LIKE CONCAT('%', #{title}, '%')
        </if>
        <if test="author != null and author != ''">
            AND b.author LIKE CONCAT('%', #{author}, '%')
        </if>
        <if test="categoryId != null">
            AND b.category_id = #{categoryId}
        </if>
        ORDER BY b.create_time DESC
    </select>

</mapper>