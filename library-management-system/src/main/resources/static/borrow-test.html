<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€Ÿé˜…åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            padding: 12px 24px;
            margin: 10px 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .primary-btn {
            background-color: #007bff;
            color: white;
        }
        .success-btn {
            background-color: #28a745;
            color: white;
        }
        .warning-btn {
            background-color: #ffc107;
            color: black;
        }
        .danger-btn {
            background-color: #dc3545;
            color: white;
        }
        .info-btn {
            background-color: #17a2b8;
            color: white;
        }
        button:hover {
            opacity: 0.9;
        }
        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .record-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .record-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #007bff;
        }
        .record-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .record-detail {
            font-size: 14px;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-1 { background: #cce5ff; color: #004085; } /* å€Ÿé˜…ä¸­ */
        .status-2 { background: #d4edda; color: #155724; } /* å·²å½’è¿˜ */
        .status-3 { background: #f8d7da; color: #721c24; } /* é€¾æœŸ */
        h1, h2, h3 {
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š å€Ÿé˜…åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>

        <div id="status" class="message info">å‡†å¤‡æµ‹è¯•å€Ÿé˜…åŠŸèƒ½...</div>

        <!-- å€Ÿé˜…ç»Ÿè®¡ -->
        <div class="section">
            <h2>ğŸ“Š å€Ÿé˜…ç»Ÿè®¡</h2>
            <button class="info-btn" onclick="loadStatistics()">åˆ·æ–°ç»Ÿè®¡</button>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalRecords">-</div>
                    <div class="stat-label">æ€»å€Ÿé˜…è®°å½•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="currentBorrows">-</div>
                    <div class="stat-label">å½“å‰å€Ÿé˜…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="overdueRecords">-</div>
                    <div class="stat-label">é€¾æœŸè®°å½•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalFines">-</div>
                    <div class="stat-label">æ€»ç½šé‡‘</div>
                </div>
            </div>
        </div>

        <!-- å€Ÿé˜…å›¾ä¹¦ -->
        <div class="section">
            <h2>ğŸ“– å€Ÿé˜…å›¾ä¹¦</h2>
            <form id="borrowForm">
                <div class="form-group">
                    <label for="userId">ç”¨æˆ·ID:</label>
                    <input type="number" id="userId" value="2" required>
                </div>
                <div class="form-group">
                    <label for="bookId">å›¾ä¹¦ID:</label>
                    <input type="number" id="bookId" value="1" required>
                </div>
                <button type="submit" class="success-btn">å€Ÿé˜…å›¾ä¹¦</button>
            </form>
        </div>

        <!-- å½’è¿˜/ç»­å€Ÿ -->
        <div class="section">
            <h2>ğŸ”„ å½’è¿˜/ç»­å€Ÿæ“ä½œ</h2>
            <div class="form-group">
                <label for="recordId">å€Ÿé˜…è®°å½•ID:</label>
                <input type="number" id="recordId" placeholder="è¾“å…¥å€Ÿé˜…è®°å½•ID">
            </div>
            <button class="primary-btn" onclick="returnBook()">å½’è¿˜å›¾ä¹¦</button>
            <button class="warning-btn" onclick="renewBook()">ç»­å€Ÿå›¾ä¹¦</button>
        </div>

        <!-- æŸ¥çœ‹å€Ÿé˜…è®°å½• -->
        <div class="section">
            <h2>ğŸ“‹ æŸ¥çœ‹å€Ÿé˜…è®°å½•</h2>
            <div class="form-group">
                <label for="userIdView">ç”¨æˆ·ID:</label>
                <input type="number" id="userIdView" value="2">
            </div>
            <button class="info-btn" onclick="loadUserRecords()">æŸ¥çœ‹ç”¨æˆ·å€Ÿé˜…è®°å½•</button>
            <button class="info-btn" onclick="loadCurrentBorrows()">æŸ¥çœ‹å½“å‰å€Ÿé˜…</button>
        </div>

        <!-- è®°å½•æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“– å€Ÿé˜…è®°å½•åˆ—è¡¨</h2>
            <div id="recordsList"></div>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
            <button class="primary-btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api';

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function showMessage(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `message ${type}`;
            statusDiv.textContent = message;
            log(`æ˜¾ç¤ºæ¶ˆæ¯: [${type}] ${message}`);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }

        async function loadStatistics() {
            try {
                log('åŠ è½½å€Ÿé˜…ç»Ÿè®¡...');
                const response = await fetch(`${API_BASE_URL}/borrow-records/statistics`);
                const data = await response.json();

                if (data.success) {
                    const stats = data.data;
                    document.getElementById('totalRecords').textContent = stats.totalRecords;
                    document.getElementById('currentBorrows').textContent = stats.currentBorrows;
                    document.getElementById('overdueRecords').textContent = stats.overdueRecords;
                    document.getElementById('totalFines').textContent = 'Â¥' + stats.totalFines.toFixed(2);

                    showMessage('å€Ÿé˜…ç»Ÿè®¡åŠ è½½æˆåŠŸ', 'success');
                    log(`ç»Ÿè®¡ä¿¡æ¯: ${JSON.stringify(stats, null, 2)}`);
                } else {
                    showMessage('åŠ è½½ç»Ÿè®¡å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                log('åŠ è½½ç»Ÿè®¡é”™è¯¯: ' + error.message);
                showMessage('åŠ è½½ç»Ÿè®¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function borrowBook() {
            const userId = document.getElementById('userId').value;
            const bookId = document.getElementById('bookId').value;

            if (!userId || !bookId) {
                showMessage('è¯·å¡«å†™ç”¨æˆ·IDå’Œå›¾ä¹¦ID', 'warning');
                return;
            }

            try {
                log(`å¼€å§‹å€Ÿé˜…: ç”¨æˆ·ID=${userId}, å›¾ä¹¦ID=${bookId}`);
                showMessage('æ­£åœ¨å€Ÿé˜…å›¾ä¹¦...', 'info');

                const response = await fetch(`${API_BASE_URL}/borrow-records/borrow?userId=${userId}&bookId=${bookId}`, {
                    method: 'POST'
                });

                const data = await response.json();
                log(`å€Ÿé˜…å“åº”: ${JSON.stringify(data, null, 2)}`);

                if (data.success) {
                    showMessage('âœ… å›¾ä¹¦å€Ÿé˜…æˆåŠŸï¼', 'success');
                    loadStatistics(); // åˆ·æ–°ç»Ÿè®¡
                } else {
                    showMessage('âŒ å€Ÿé˜…å¤±è´¥: ' + data.message, 'error');
                }

            } catch (error) {
                log('å€Ÿé˜…é”™è¯¯: ' + error.message);
                showMessage('âŒ å€Ÿé˜…å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function returnBook() {
            const recordId = document.getElementById('recordId').value;

            if (!recordId) {
                showMessage('è¯·è¾“å…¥å€Ÿé˜…è®°å½•ID', 'warning');
                return;
            }

            try {
                log(`å¼€å§‹å½’è¿˜: è®°å½•ID=${recordId}`);
                showMessage('æ­£åœ¨å½’è¿˜å›¾ä¹¦...', 'info');

                const response = await fetch(`${API_BASE_URL}/borrow-records/${recordId}/return`, {
                    method: 'POST'
                });

                const data = await response.json();
                log(`å½’è¿˜å“åº”: ${JSON.stringify(data, null, 2)}`);

                if (data.success) {
                    showMessage('âœ… å›¾ä¹¦å½’è¿˜æˆåŠŸï¼', 'success');
                    loadStatistics(); // åˆ·æ–°ç»Ÿè®¡
                    loadUserRecords(); // åˆ·æ–°è®°å½•åˆ—è¡¨
                } else {
                    showMessage('âŒ å½’è¿˜å¤±è´¥: ' + data.message, 'error');
                }

            } catch (error) {
                log('å½’è¿˜é”™è¯¯: ' + error.message);
                showMessage('âŒ å½’è¿˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function renewBook() {
            const recordId = document.getElementById('recordId').value;

            if (!recordId) {
                showMessage('è¯·è¾“å…¥å€Ÿé˜…è®°å½•ID', 'warning');
                return;
            }

            try {
                log(`å¼€å§‹ç»­å€Ÿ: è®°å½•ID=${recordId}`);
                showMessage('æ­£åœ¨ç»­å€Ÿå›¾ä¹¦...', 'info');

                const response = await fetch(`${API_BASE_URL}/borrow-records/${recordId}/renew`, {
                    method: 'POST'
                });

                const data = await response.json();
                log(`ç»­å€Ÿå“åº”: ${JSON.stringify(data, null, 2)}`);

                if (data.success) {
                    showMessage('âœ… å›¾ä¹¦ç»­å€ŸæˆåŠŸï¼', 'success');
                    loadUserRecords(); // åˆ·æ–°è®°å½•åˆ—è¡¨
                } else {
                    showMessage('âŒ ç»­å€Ÿå¤±è´¥: ' + data.message, 'error');
                }

            } catch (error) {
                log('ç»­å€Ÿé”™è¯¯: ' + error.message);
                showMessage('âŒ ç»­å€Ÿå¤±è´¥: ' + error.message, 'error');
            }
        }

        async function loadUserRecords() {
            const userId = document.getElementById('userIdView').value;

            if (!userId) {
                showMessage('è¯·è¾“å…¥ç”¨æˆ·ID', 'warning');
                return;
            }

            try {
                log(`åŠ è½½ç”¨æˆ·å€Ÿé˜…è®°å½•: ç”¨æˆ·ID=${userId}`);
                const response = await fetch(`${API_BASE_URL}/borrow-records/user/${userId}?page=0&size=20`);
                const data = await response.json();

                if (data.success) {
                    displayRecords(data.data.content);
                    showMessage(`ç”¨æˆ· ${userId} çš„å€Ÿé˜…è®°å½•åŠ è½½æˆåŠŸ`, 'success');
                } else {
                    showMessage('åŠ è½½å€Ÿé˜…è®°å½•å¤±è´¥: ' + data.message, 'error');
                }

            } catch (error) {
                log('åŠ è½½è®°å½•é”™è¯¯: ' + error.message);
                showMessage('åŠ è½½å€Ÿé˜…è®°å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function loadCurrentBorrows() {
            const userId = document.getElementById('userIdView').value;

            if (!userId) {
                showMessage('è¯·è¾“å…¥ç”¨æˆ·ID', 'warning');
                return;
            }

            try {
                log(`åŠ è½½ç”¨æˆ·å½“å‰å€Ÿé˜…: ç”¨æˆ·ID=${userId}`);
                const response = await fetch(`${API_BASE_URL}/borrow-records/user/${userId}/current`);
                const data = await response.json();

                if (data.success) {
                    displayRecords(data.data);
                    showMessage(`ç”¨æˆ· ${userId} çš„å½“å‰å€Ÿé˜…åŠ è½½æˆåŠŸ`, 'success');
                } else {
                    showMessage('åŠ è½½å½“å‰å€Ÿé˜…å¤±è´¥: ' + data.message, 'error');
                }

            } catch (error) {
                log('åŠ è½½å½“å‰å€Ÿé˜…é”™è¯¯: ' + error.message);
                showMessage('åŠ è½½å½“å‰å€Ÿé˜…å¤±è´¥: ' + error.message, 'error');
            }
        }

        function displayRecords(records) {
            const recordsList = document.getElementById('recordsList');

            if (!records || records.length === 0) {
                recordsList.innerHTML = '<p style="color: #666;">æš‚æ— å€Ÿé˜…è®°å½•</p>';
                return;
            }

            let html = '';
            records.forEach(record => {
                const statusClass = `status-${record.status}`;
                const statusText = getStatusText(record.status);

                html += `
                    <div class="record-item">
                        <div class="record-header">
                            å€Ÿé˜…è®°å½• #${record.id}
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="record-details">
                            <div class="record-detail"><strong>ç”¨æˆ·:</strong> ${record.user ? record.user.realName || record.user.username : 'æœªçŸ¥'}</div>
                            <div class="record-detail"><strong>å›¾ä¹¦:</strong> ${record.book ? record.book.title : 'æœªçŸ¥'}</div>
                            <div class="record-detail"><strong>å€Ÿé˜…æ—¥æœŸ:</strong> ${new Date(record.borrowDate).toLocaleString()}</div>
                            <div class="record-detail"><strong>åº”è¿˜æ—¥æœŸ:</strong> ${new Date(record.dueDate).toLocaleString()}</div>
                            ${record.returnDate ? `<div class="record-detail"><strong>å½’è¿˜æ—¥æœŸ:</strong> ${new Date(record.returnDate).toLocaleString()}</div>` : ''}
                            <div class="record-detail"><strong>ç»­å€Ÿæ¬¡æ•°:</strong> ${record.renewCount || 0}</div>
                            <div class="record-detail"><strong>ç½šé‡‘:</strong> Â¥${(record.fineAmount || 0).toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });

            recordsList.innerHTML = html;
        }

        function getStatusText(status) {
            switch (status) {
                case 1: return 'å€Ÿé˜…ä¸­';
                case 2: return 'å·²å½’è¿˜';
                case 3: return 'é€¾æœŸ';
                default: return 'æœªçŸ¥';
            }
        }

        // ç»‘å®šè¡¨å•äº‹ä»¶
        document.getElementById('borrowForm').addEventListener('submit', function(e) {
            e.preventDefault();
            borrowBook();
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½ç»Ÿè®¡
        window.addEventListener('load', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åŠ è½½å€Ÿé˜…ç»Ÿè®¡');
            loadStatistics();
            showMessage('å€Ÿé˜…åŠŸèƒ½æµ‹è¯•é¡µé¢å·²å‡†å¤‡å°±ç»ª', 'info');
        });
    </script>
</body>
</html>